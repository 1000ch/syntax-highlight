<script src="bower_components/es6-promise/promise.min.js"></script>
<script src="bower_components/fetch/fetch.js"></script>
<script src="bower_components/highlightjs/highlight.pack.js"></script>
<link rel="stylesheet" href="bower_components/highlightjs/styles/default.css">

<template id='template-syntax-highlight'>
  <style>
    :host {
      display: block;
    }
    :host pre {
      overflow: auto;
    }
    :host code {
      font-family: monospace, monospace;
      font-size: 1em;
    }
  </style>
  <pre><code><content></content></code></pre>
</template>

<script>

  var currentScript = document.currentScript;
  var ownerDocument = currentScript.ownerDocument;
  var SyntaxHighlightPrototype = Object.create(HTMLElement.prototype);

  SyntaxHighlightPrototype.createdCallback = function () {

    // 別途保持する
    var originalHTML = this.innerHTML;

    this.shadowRoot = this.createShadowRoot();
    var template = ownerDocument.querySelector('#template-syntax-highlight');
    var clone = document.importNode(template.content, true);
    this.shadowRoot.appendChild(clone);
    this.shadowRoot.querySelector('code').textContent = originalHTML;
  };

  SyntaxHighlightPrototype.attachedCallback = function () {

    var style = this.shadowRoot.querySelector('style');
    var link = ownerDocument.querySelector('link[rel="stylesheet"]');

    fetch(link.href).then(function (response) {
      return response.text();
    }).then(function (css) {
      style.innerHTML += css;
    });

    var code = this.shadowRoot.querySelector('code');
    code.classList.add(this.getAttribute('lang'));
    hljs.highlightBlock(code);
  };

  window.SyntaxHighlight = document.registerElement('syntax-highlight', {
    prototype: SyntaxHighlightPrototype
  });

</script>